{% extends 'calculator/base.html' %}
{% load static %}
{% load history_filters %}
{% load tz %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card calculator-card text-white mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="card-title mb-0">
                            <i class="fas fa-history"></i> Calculation History
                        </h2>
                        <p class="mb-0 mt-2">All calculations across all sections -EAT</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group">
                            <button type="button" class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-download"></i> Download History
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{% url 'download_history' 'json' %}">
                                    <i class="fas fa-file-code"></i> JSON Format
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'download_history' 'csv' %}">
                                    <i class="fas fa-file-csv"></i> CSV Format
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'download_history' 'txt' %}">
                                    <i class="fas fa-file-alt"></i> Text Format
                                </a></li>
                            </ul>
                        </div>
                        <button class="btn btn-outline-light ms-2" id="clearFilters">
                            <i class="fas fa-filter"></i> Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h4 class="card-title" id="totalCount">{{ calculations.count }}</h4>
                        <p class="card-text">Total</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h4 class="card-title" id="extrusionCount">0</h4>
                        <p class="card-text">Extrusion</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h4 class="card-title" id="printingCount">0</h4>
                        <p class="card-text">Printing</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-warning text-dark">
                    <div class="card-body text-center">
                        <h4 class="card-title" id="laminationCount">0</h4>
                        <p class="card-text">Lamination</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-secondary text-white">
                    <div class="card-body text-center">
                        <h4 class="card-title" id="slittingCount">0</h4>
                        <p class="card-text">Slitting</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-dark text-white">
                    <div class="card-body text-center">
                        <h4 class="card-title" id="bagMakingCount">0</h4>
                        <p class="card-text">Bag Making</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales Statistics Card -->
        <div class="row mb-4">
            <div class="col-md-2 offset-md-4">
                <div class="card bg-purple text-white">
                    <div class="card-body text-center">
                        <h4 class="card-title" id="salesCount">0</h4>
                        <p class="card-text">Sales</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Section Navigation -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-rocket"></i> Quick Navigation</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-2">
                        <a href="{% url 'extrusion:extrusion_home' %}" class="btn btn-success w-100">
                            <i class="fas fa-industry"></i> Extrusion
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a href="{% url 'printing:printing_home' %}" class="btn btn-info w-100">
                            <i class="fas fa-print"></i> Printing
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a href="{% url 'lamination:lamination_home' %}" class="btn btn-warning w-100">
                            <i class="fas fa-layer-group"></i> Lamination
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a href="{% url 'slitting:slitting_home' %}" class="btn btn-secondary w-100">
                            <i class="fas fa-cut"></i> Slitting
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a href="{% url 'bag_making:bag_making_home' %}" class="btn btn-dark w-100">
                            <i class="fas fa-shopping-bag"></i> Bag Making
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a href="{% url 'sales:sales_home' %}" class="btn btn-purple w-100">
                            <i class="fas fa-money-bill-wave"></i> Sales
                        </a>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12 text-center">
                        <a href="{% url 'home' %}" class="btn btn-outline-primary">
                            <i class="fas fa-home"></i> Main Calculator
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Section</label>
                        <select class="form-select" id="sectionFilter">
                            <option value="">All Sections</option>
                            <option value="extrusion">Extrusion</option>
                            <option value="printing">Printing</option>
                            <option value="lamination">Lamination</option>
                            <option value="slitting">Slitting</option>
                            <option value="bag_making">Bag Making</option>
                            <option value="sales">Sales</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Calculation Type</label>
                        <select class="form-select" id="typeFilter">
                            <option value="">All Types</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Material</label>
                        <select class="form-select" id="materialFilter">
                            <option value="">All Materials</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date Range</label>
                        <input type="date" class="form-control" id="dateFilter">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showOnlyRecent">
                            <label class="form-check-label" for="showOnlyRecent">
                                Show only last 7 days
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-secondary btn-sm" id="exportSelected">
                            <i class="fas fa-download"></i> Export Selected
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calculations Table -->
        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="calculationsTable">
                        <thead class="table-dark">
                            <tr>
                                <th width="40">
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th>Date & Time (EAT)</th>
                                <th>Section</th>
                                <th>Calculation Type</th>
                                <th>Material</th>
                                <th>Input Parameters</th>
                                <th>Results</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for calculation in calculations %}
                            {% timezone "Africa/Nairobi" %}
                            <tr class="calculation-row"
                                data-section="{{ calculation|get_section_name|lower }}"
                                data-type="{{ calculation.calculation_type }}"
                                data-material="{% if calculation.material %}{{ calculation.material.name }}{% endif %}"
                                data-date="{{ calculation.timestamp|date:'Y-m-d' }}"
                                data-recent="{% if calculation.is_recent %}true{% else %}false{% endif %}">
                                <td>
                                    <input type="checkbox" class="calculation-checkbox" value="{{ calculation.id }}">
                                </td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <small class="text-muted">
                                            {{ calculation.timestamp|date:"M d, Y" }}
                                        </small>
                                        <small class="text-muted">
                                            {{ calculation.timestamp|date:"H:i" }} EAT
                                        </small>
                                        {% if calculation.is_recent %}
                                        <span class="badge bg-success badge-sm mt-1">Recent</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge {{ calculation|get_section_badge }}">
                                        <i class="{{ calculation|get_section_icon }} me-1"></i>
                                        {{ calculation|get_section_name }}
                                    </span>
                                </td>
                                <td>
                                    <strong>{{ calculation|get_calculation_type_display }}</strong>
                                    {% if calculation.description %}
                                    <br><small class="text-muted">{{ calculation.description }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if calculation.material %}
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-light text-dark me-2">
                                            {{ calculation.material.name }}
                                        </span>
                                        <small class="text-muted">({{ calculation.material.density }} g/cm³)</small>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary view-input-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#inputModal"
                                            data-calculation-id="{{ calculation.id }}"
                                            data-input-data="{{ calculation.input_data|parse_calculation_data|safe }}">
                                        <i class="fas fa-eye"></i> View Input
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-success view-result-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#resultModal"
                                            data-calculation-id="{{ calculation.id }}"
                                            data-result-data="{{ calculation.result_data|parse_calculation_data|safe }}"
                                            data-type="{{ calculation|get_calculation_type_display }}">
                                        <i class="fas fa-chart-bar"></i> View Results
                                    </button>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-info recalculate-btn"
                                                data-calculation='{{ calculation.id }}'
                                                data-type="{{ calculation.calculation_type }}"
                                                data-section="{{ calculation|get_section_name|lower }}">
                                            <i class="fas fa-redo"></i> Redo
                                        </button>
                                        <button class="btn btn-outline-warning duplicate-btn"
                                                data-calculation='{{ calculation.id }}'>
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <button class="btn btn-outline-danger delete-btn"
                                                data-calculation='{{ calculation.id }}'
                                                data-calculation-name="{{ calculation|get_calculation_type_display }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endtimezone %}
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <div class="text-muted">
                                        <i class="fas fa-calculator fa-4x mb-3"></i>
                                        <h4>No calculations found</h4>
                                        <p class="mb-4">Your calculation history will appear here once you start using the calculators.</p>
                                        <div class="row justify-content-center">
                                            <div class="col-auto">
                                                <a href="{% url 'extrusion:extrusion_home' %}" class="btn btn-primary me-2">
                                                    <i class="fas fa-industry"></i> Start with Extrusion
                                                </a>
                                                <a href="{% url 'sales:sales_home' %}" class="btn btn-purple me-2">
                                                    <i class="fas fa-money-bill-wave"></i> Try Sales
                                                </a>
                                                <a href="{% url 'home' %}" class="btn btn-outline-primary">
                                                    <i class="fas fa-home"></i> Go to Main Calculator
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Selected Actions -->
                <div class="row mt-3" id="selectedActions" style="display: none;">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span id="selectedCount">0 calculations selected</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-danger me-2" id="deleteSelected">
                                            <i class="fas fa-trash"></i> Delete Selected
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" id="exportSelectedBtn">
                                            <i class="fas fa-download"></i> Export Selected
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                {% if calculations.has_other_pages %}
                <nav aria-label="Calculation history pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if calculations.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ calculations.previous_page_number }}">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                        </li>
                        {% endif %}

                        {% for num in calculations.paginator.page_range %}
                            {% if calculations.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > calculations.number|add:'-3' and num < calculations.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {% if calculations.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ calculations.next_page_number }}">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Input Data Modal -->
<div class="modal fade" id="inputModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-list-ul"></i> Input Parameters
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="inputDataContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading input data...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn btn-primary" id="copyInputData">
                    <i class="fas fa-copy"></i> Copy Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Result Data Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">
                    <i class="fas fa-chart-bar"></i> Calculation Results
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="resultDataContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading result data...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn btn-success" id="copyResultData">
                    <i class="fas fa-copy"></i> Copy Results
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteCalculationName">this calculation</strong>?</p>
                <p class="text-muted small">This action cannot be undone and the calculation will be permanently removed from your history.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Confirmation Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Confirm Bulk Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="bulkDeleteCount">0 calculations</strong>?</p>
                <p class="text-muted small">This action cannot be undone and all selected calculations will be permanently removed.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmBulkDelete">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize statistics first
    initializeStatistics();

    // Initialize filters
    initializeFilters();

    // Set up event listeners
    document.getElementById('sectionFilter').addEventListener('change', filterCalculations);
    document.getElementById('typeFilter').addEventListener('change', filterCalculations);
    document.getElementById('materialFilter').addEventListener('change', filterCalculations);
    document.getElementById('dateFilter').addEventListener('change', filterCalculations);
    document.getElementById('showOnlyRecent').addEventListener('change', filterCalculations);
    document.getElementById('clearFilters').addEventListener('click', clearFilters);

    // Selection handlers
    document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
    document.getElementById('deleteSelected').addEventListener('click', showBulkDeleteModal);
    document.getElementById('exportSelectedBtn').addEventListener('click', exportSelectedCalculations);
    document.getElementById('confirmBulkDelete').addEventListener('click', deleteSelectedCalculations);

    // Set up modal handlers
    setupModalHandlers();

    // Also update when any filter changes
    document.querySelectorAll('#sectionFilter, #typeFilter, #materialFilter, #dateFilter, #showOnlyRecent')
        .forEach(element => {
            element.addEventListener('change', updateStatistics);
        });
});

function initializeStatistics() {
    const sectionCounts = {
        extrusion: 0,
        printing: 0,
        lamination: 0,
        slitting: 0,
        bag_making: 0,  // This is what we're looking for
        sales: 0
    };

    // Count all rows by section on page load
    document.querySelectorAll('.calculation-row').forEach(row => {
        const section = row.dataset.section;
        console.log('Found row with section:', section); // Debug log

        // Handle different section name formats
        if (section === 'bag making') {
            sectionCounts.bag_making++;
        } else if (section === 'bag_making') {
            sectionCounts.bag_making++;
        } else if (sectionCounts.hasOwnProperty(section)) {
            sectionCounts[section]++;
        }
    });

    // Debug: log the counts
    console.log('Section counts:', sectionCounts);

    // Update all section counts
    document.getElementById('extrusionCount').textContent = sectionCounts.extrusion;
    document.getElementById('printingCount').textContent = sectionCounts.printing;
    document.getElementById('laminationCount').textContent = sectionCounts.lamination;
    document.getElementById('slittingCount').textContent = sectionCounts.slitting;
    document.getElementById('bagMakingCount').textContent = sectionCounts.bag_making;
    document.getElementById('salesCount').textContent = sectionCounts.sales;

    // Update total count
    const totalCount = document.querySelectorAll('.calculation-row').length;
    document.getElementById('totalCount').textContent = totalCount;
}

function initializeFilters() {
    // Populate type filter
    const types = new Set();
    document.querySelectorAll('.calculation-row').forEach(row => {
        types.add(row.dataset.type);
    });

    const typeFilter = document.getElementById('typeFilter');
    types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        typeFilter.appendChild(option);
    });

    // Populate material filter
    const materials = new Set();
    document.querySelectorAll('.calculation-row').forEach(row => {
        if (row.dataset.material) {
            materials.add(row.dataset.material);
        }
    });

    const materialFilter = document.getElementById('materialFilter');
    materials.forEach(material => {
        const option = document.createElement('option');
        option.value = material;
        option.textContent = material;
        materialFilter.appendChild(option);
    });
}

function filterCalculations() {
    const sectionFilter = document.getElementById('sectionFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const materialFilter = document.getElementById('materialFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const showOnlyRecent = document.getElementById('showOnlyRecent').checked;

    let visibleCount = 0;

    document.querySelectorAll('.calculation-row').forEach(row => {
        let show = true;

        if (sectionFilter && row.dataset.section !== sectionFilter) {
            show = false;
        }

        if (typeFilter && row.dataset.type !== typeFilter) {
            show = false;
        }

        if (materialFilter && row.dataset.material !== materialFilter) {
            show = false;
        }

        if (dateFilter && row.dataset.date !== dateFilter) {
            show = false;
        }

        if (showOnlyRecent && row.dataset.recent !== 'true') {
            show = false;
        }

        if (show) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    updateStatistics();
    updateSelectionUI();
}

function clearFilters() {
    document.getElementById('sectionFilter').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('materialFilter').value = '';
    document.getElementById('dateFilter').value = '';
    document.getElementById('showOnlyRecent').checked = false;
    filterCalculations();
}

function updateStatistics() {
    const visibleRows = document.querySelectorAll('.calculation-row[style=""]');
    const sectionCounts = {
        extrusion: 0,
        printing: 0,
        lamination: 0,
        slitting: 0,
        bag_making: 0,
        sales: 0
    };

    // Count visible rows by section
    visibleRows.forEach(row => {
        const section = row.dataset.section;

        // Handle different section name formats
        if (section === 'bag making') {
            sectionCounts.bag_making++;
        } else if (section === 'bag_making') {
            sectionCounts.bag_making++;
        } else if (sectionCounts.hasOwnProperty(section)) {
            sectionCounts[section]++;
        }
    });

    // Update all section counts
    document.getElementById('extrusionCount').textContent = sectionCounts.extrusion;
    document.getElementById('printingCount').textContent = sectionCounts.printing;
    document.getElementById('laminationCount').textContent = sectionCounts.lamination;
    document.getElementById('slittingCount').textContent = sectionCounts.slitting;
    document.getElementById('bagMakingCount').textContent = sectionCounts.bag_making;
    document.getElementById('salesCount').textContent = sectionCounts.sales;

    // Update total count
    const totalCount = visibleRows.length;
    document.getElementById('totalCount').textContent = totalCount;
}

// Selection Management
function toggleSelectAll() {
    const isChecked = document.getElementById('selectAll').checked;
    document.querySelectorAll('.calculation-checkbox').forEach(checkbox => {
        if (checkbox.closest('tr').style.display !== 'none') {
            checkbox.checked = isChecked;
        }
    });
    updateSelectionUI();
}

function updateSelectionUI() {
    const selectedCount = document.querySelectorAll('.calculation-checkbox:checked').length;
    const selectedActions = document.getElementById('selectedActions');
    const selectedCountElement = document.getElementById('selectedCount');

    if (selectedCount > 0) {
        selectedActions.style.display = 'block';
        selectedCountElement.textContent = `${selectedCount} calculation${selectedCount !== 1 ? 's' : ''} selected`;
    } else {
        selectedActions.style.display = 'none';
    }

    // Update select all checkbox state
    const visibleCheckboxes = document.querySelectorAll('.calculation-checkbox');
    const checkedVisibleCheckboxes = Array.from(visibleCheckboxes).filter(cb =>
        cb.checked && cb.closest('tr').style.display !== 'none'
    );
    document.getElementById('selectAll').checked = checkedVisibleCheckboxes.length > 0 &&
                                                 checkedVisibleCheckboxes.length === visibleCheckboxes.length;
    document.getElementById('selectAll').indeterminate = checkedVisibleCheckboxes.length > 0 &&
                                                       checkedVisibleCheckboxes.length < visibleCheckboxes.length;
}

function deleteCalculation(calculationId) {
    console.log('Deleting calculation:', calculationId);
    const deleteUrl = `/delete-calculation/${calculationId}/`;
    console.log('Delete URL:', deleteUrl);

    fetch(deleteUrl, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Delete response:', data);
        if (data.success) {
            // Find and remove the row
            const row = document.querySelector(`.calculation-checkbox[value="${calculationId}"]`);
            if (row && row.closest('tr')) {
                row.closest('tr').remove();
            }

            // Hide the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            if (modal) {
                modal.hide();
            }

            // Update statistics and UI
            updateStatistics();
            updateSelectionUI();
            showToast(data.message || 'Calculation deleted successfully!', 'success');
        } else {
            showToast('Error deleting calculation: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error deleting calculation. Please try again.', 'error');
    });
}

function showBulkDeleteModal() {
    const selectedCount = document.querySelectorAll('.calculation-checkbox:checked').length;
    document.getElementById('bulkDeleteCount').textContent = `${selectedCount} calculation${selectedCount !== 1 ? 's' : ''}`;
    new bootstrap.Modal(document.getElementById('bulkDeleteModal')).show();
}

function deleteSelectedCalculations() {
    const selectedIds = Array.from(document.querySelectorAll('.calculation-checkbox:checked'))
        .map(checkbox => checkbox.value);

    if (selectedIds.length === 0) {
        showToast('Please select calculations to delete', 'warning');
        return;
    }

    fetch('/delete-calculations-bulk/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ calculation_ids: selectedIds })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Remove selected rows from the table
            selectedIds.forEach(id => {
                const checkbox = document.querySelector(`.calculation-checkbox[value="${id}"]`);
                if (checkbox && checkbox.closest('tr')) {
                    checkbox.closest('tr').remove();
                }
            });

            const modal = bootstrap.Modal.getInstance(document.getElementById('bulkDeleteModal'));
            if (modal) {
                modal.hide();
            }

            updateStatistics();
            updateSelectionUI();
            showToast(data.message || 'Calculations deleted successfully!', 'success');
        } else {
            showToast('Error deleting calculations: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error deleting calculations. Please try again.', 'error');
    });
}

function exportSelectedCalculations() {
    const selectedIds = Array.from(document.querySelectorAll('.calculation-checkbox:checked'))
        .map(checkbox => checkbox.value);

    if (selectedIds.length === 0) {
        showToast('Please select calculations to export', 'warning');
        return;
    }

    const url = `/export-calculations/?ids=${selectedIds.join(',')}`;
    window.open(url, '_blank');
}

function setupModalHandlers() {
    // Input data modal
    document.querySelectorAll('.view-input-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const inputData = this.dataset.inputData;
            const content = document.getElementById('inputDataContent');

            try {
                let cleanedData = inputData.trim();
                if (cleanedData.startsWith('"') && cleanedData.endsWith('"')) {
                    cleanedData = cleanedData.slice(1, -1);
                }
                cleanedData = cleanedData.replace(/\\"/g, '"');
                cleanedData = cleanedData.replace(/\\'/g, "'");

                const parsedData = JSON.parse(cleanedData);
                content.innerHTML = formatInputData(parsedData);
            } catch (error) {
                content.innerHTML = extractDataFromString(inputData, 'input');
            }
        });
    });

    // Result data modal
    document.querySelectorAll('.view-result-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const resultData = this.dataset.resultData;
            const calculationType = this.dataset.type;
            const content = document.getElementById('resultDataContent');
            const title = document.getElementById('resultModalTitle');

            title.textContent = `${calculationType} - Results`;

            try {
                let cleanedData = resultData.trim();
                if (cleanedData.startsWith('"') && cleanedData.endsWith('"')) {
                    cleanedData = cleanedData.slice(1, -1);
                }
                cleanedData = cleanedData.replace(/\\"/g, '"');
                cleanedData = cleanedData.replace(/\\'/g, "'");

                const parsedData = JSON.parse(cleanedData);
                content.innerHTML = formatResultData(parsedData);
            } catch (error) {
                content.innerHTML = extractDataFromString(resultData, 'result');
            }
        });
    });

    // Copy buttons
    document.getElementById('copyInputData').addEventListener('click', function() {
        copyToClipboard(document.getElementById('inputDataContent').innerText);
        showToast('Input data copied to clipboard!', 'success');
    });

    document.getElementById('copyResultData').addEventListener('click', function() {
        copyToClipboard(document.getElementById('resultDataContent').innerText);
        showToast('Results copied to clipboard!', 'success');
    });

    // Delete buttons
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const calculationId = this.dataset.calculation;
            const calculationName = this.dataset.calculationName;
            document.getElementById('deleteCalculationName').textContent = calculationName;
            document.getElementById('confirmDelete').dataset.calculationId = calculationId;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        });
    });

    // Confirm delete
    document.getElementById('confirmDelete').addEventListener('click', function() {
        const calculationId = this.dataset.calculationId;
        deleteCalculation(calculationId);
    });

    // Checkbox change events
    document.querySelectorAll('.calculation-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectionUI);
    });
}

function extractDataFromString(dataString, dataType) {
    let html = '<div class="alert alert-info">';
    html += `<h6><i class="fas fa-info-circle"></i> ${dataType === 'input' ? 'Input' : 'Result'} Data</h6>`;

    try {
        const pairs = dataString.split(',');
        let extractedData = {};

        pairs.forEach(pair => {
            const [key, value] = pair.split(':').map(part => part.trim().replace(/['"]/g, ''));
            if (key && value !== undefined) {
                extractedData[key] = value;
            }
        });

        if (Object.keys(extractedData).length > 0) {
            if (dataType === 'input') {
                html += formatInputData(extractedData);
            } else {
                html += formatResultData(extractedData);
            }
        } else {
            html += `<p>Raw data: <code>${escapeHtml(dataString)}</code></p>`;
        }
    } catch (error) {
        html += `<p>Could not parse data. Raw content:</p>`;
        html += `<pre class="mt-2 p-2 bg-light border rounded">${escapeHtml(dataString)}</pre>`;
    }

    html += '</div>';
    return html;
}

function formatInputData(inputData) {
    console.log('Raw input data:', inputData);

    let parsedData;

    try {
        // If it's already an object, use it directly
        if (typeof inputData === 'object') {
            parsedData = inputData;
        } else {
            // Try to parse as JSON
            parsedData = JSON.parse(inputData);
        }
    } catch (error) {
        console.log('JSON parse failed, using raw data:', error);
        // If parsing fails, use the data as is (it might already be parsed by the template filter)
        parsedData = inputData;
    }

    return generateParameterTable(parsedData, 'Parameter');
}

function formatResultData(resultData) {
    console.log('Raw result data:', resultData);

    let parsedData;

    try {
        // If it's already an object, use it directly
        if (typeof resultData === 'object') {
            parsedData = resultData;
        } else {
            // Try to parse as JSON
            parsedData = JSON.parse(resultData);
        }
    } catch (error) {
        console.log('JSON parse failed, using raw data:', error);
        // If parsing fails, use the data as is
        parsedData = resultData;
    }

    return generateParameterTable(parsedData, 'Result');
}

function generateParameterTable(data, columnName) {
    let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
    html += `<thead><tr><th>${columnName}</th><th>Value</th><th>Unit</th></tr></thead><tbody>`;

    // Define unit mappings for common parameters
    const unitMappings = {
        // Mass/Weight
        'mass': 'kg', 'weight': 'kg', 'roll_mass': 'kg',

        // Dimensions
        'diameter': 'mm', 'core_diameter': 'mm', 'width': 'mm', 'length': 'm',
        'outer_diameter': 'm', 'thickness': 'microns',

        // Density
        'density': 'g/cm³', 'effective_density': 'g/cm³',

        // GSM
        'gsm': 'gsm',

        // Count
        'layer_count': '', 'count': '',

        // Imperial
        'inch': 'in'
    };

    for (const [key, value] of Object.entries(data)) {
        // Skip internal fields
        if (['material_id', 'csrfmiddlewaretoken', 'calculation_type', 'material_details'].includes(key)) {
            continue;
        }

        // Format the parameter name
        let paramName = key.replace(/_/g, ' ')
                          .replace(/\b\w/g, l => l.toUpperCase())
                          .replace(/\b(Gsm|Id)\b/gi, match => match.toUpperCase())
                          .replace(/\b(Mm|Cm)\b/gi, match => match.toUpperCase());

        // Determine unit
        let unit = '';
        const lowerKey = key.toLowerCase();

        for (const [unitKey, unitValue] of Object.entries(unitMappings)) {
            if (lowerKey.includes(unitKey)) {
                unit = unitValue;
                break;
            }
        }

        // Special cases for units in parameter names
        if (lowerKey.includes('unit')) {
            unit = ''; // Don't show unit for unit fields themselves
        }

        html += `<tr>
            <td><strong>${paramName}</strong></td>
            <td>${formatValue(value)}</td>
            <td><small class="text-muted">${unit}</small></td>
        </tr>`;
    }

    html += '</tbody></table></div>';
    return html;
}

function formatValue(value) {
    if (value === null || value === undefined) {
        return '<em class="text-muted">N/A</em>';
    }

    if (typeof value === 'number') {
        if (Math.abs(value) < 0.001) {
            return value.toExponential(4);
        } else if (Math.abs(value) < 1) {
            return value.toFixed(4);
        } else if (Math.abs(value) < 1000) {
            return value.toFixed(2);
        } else {
            return value.toLocaleString();
        }
    }

    // Remove quotes from string values if they're wrapped
    if (typeof value === 'string') {
        let cleaned = value.trim();
        if ((cleaned.startsWith("'") && cleaned.endsWith("'")) ||
            (cleaned.startsWith('"') && cleaned.endsWith('"'))) {
            cleaned = cleaned.slice(1, -1);
        }
        return cleaned;
    }

    return value;
}

function parseParameter(key) {
    const units = {
        'mass': 'kg', 'weight': 'kg', 'thickness': 'microns', 'length': 'm',
        'width': 'm', 'density': 'g/cm³', 'speed': 'm/min', 'rate': 'kg/hr',
        'load': 'N', 'force': 'N', 'strength': 'MPa', 'elongation': '%',
        'cof': '', 'dart_impact': 'g', 'cv': '%', 'yield': 'm²/kg',
        'pieces': 'pcs', 'production_time': 'hr', 'roll_length': 'm',
        'film_length': 'm', 'tensile': 'MPa', 'elongation': '%',
        'cost': 'currency', 'budget': 'currency', 'price': 'currency'
    };

    let paramName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    let unit = '';

    for (const [unitKey, unitValue] of Object.entries(units)) {
        if (key.includes(unitKey)) {
            unit = unitValue;
            break;
        }
    }

    return { paramName, unit };
}

function formatValue(value) {
    if (typeof value === 'number') {
        if (Math.abs(value) < 0.001) {
            return value.toExponential(4);
        } else if (Math.abs(value) < 1) {
            return value.toFixed(4);
        } else if (Math.abs(value) < 1000) {
            return value.toFixed(2);
        } else {
            return value.toLocaleString();
        }
    }
    return value;
}

function deleteCalculation(calculationId) {
    fetch(`/delete-calculation/${calculationId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const row = document.querySelector(`[data-calculation="${calculationId}"]`);
            if (row) {
                row.closest('tr').remove();
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                updateStatistics();
                updateSelectionUI();
                showToast('Calculation deleted successfully!', 'success');
            }
        } else {
            showToast('Error deleting calculation: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error deleting calculation. Please try again.', 'error');
    });
}

// Utility functions
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize checkboxes
document.querySelectorAll('.calculation-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectionUI);
});
</script>

<style>
.bg-purple {
    background-color: #6f42c1 !important;
}

.btn-purple {
    background-color: #6f42c1;
    border-color: #6f42c1;
    color: white;
}

.btn-purple:hover {
    background-color: #5a359c;
    border-color: #5a359c;
    color: white;
}

.badge-sm {
    font-size: 0.7em;
    padding: 0.2em 0.4em;
}
</style>
{% endblock %}
